# AutoDocAgent - 基于 Commit 的增量文档自动生成系统
## 产品需求文档 (PRD)

**版本:** v1.0  
**日期:** 2025-07-19  
**语言:** 简体中文  
**文档类型:** 功能需求文档

---

## 1. 介绍/概述

### 1.1 产品背景
AutoDocAgent 是一个基于代码提交（commit）的增量文档自动生成系统，旨在解决开发团队在维护技术文档时面临的时效性和准确性问题。

### 1.2 问题陈述
- **文档滞后问题**: 代码更新后，对应的技术文档往往无法及时同步
- **维护成本高**: 手动维护文档消耗大量开发时间，特别是在微服务和Monorepo项目中
- **文档质量不一致**: 不同开发者编写的文档风格和质量差异较大
- **CI/CD流程缺失**: 发布流水线中缺少自动化的文档生成环节

### 1.3 解决方案
通过监听Git提交事件，自动分析代码变更，调用LLM生成高质量的中文技术文档，确保"代码即文档，文档永不过时"。

### 1.4 核心价值主张
- **3秒内完成**: 每次代码提交后3秒内自动生成对应模块文档
- **增量更新**: 只处理变更的模块，避免全量扫描的性能开销
- **高质量输出**: 生成包含功能概述、API文档、示例代码的完整README
- **零配置部署**: 提供CLI工具和GitHub Action，开箱即用

---

## 2. 目标

### 2.1 主要目标
1. **自动化文档生成**: 实现代码提交后自动生成对应模块的技术文档
2. **性能优化**: 确保增量更新总耗时不超过3秒（95%分位）
3. **多语言支持**: 支持Go、Python、Java、TypeScript四种主流编程语言
4. **易用性**: 提供CLI工具和GitHub Action，降低使用门槛

### 2.2 成功指标
- **响应时间**: 增量更新总耗时 ≤ 3秒（95%分位）
- **覆盖率**: 支持4种主流编程语言的AST解析
- **可用性**: 网络异常时降级到本地模型，成功率 > 95%
- **用户满意度**: 首次使用5分钟内完成全仓库文档生成

---

## 3. 用户故事

### 3.1 核心用户故事

#### US-1: 开源项目维护者
**作为** 一个开源项目的维护者  
**我希望** 在合并PR后自动更新项目文档  
**以便** 确保文档与代码保持同步，减少维护成本

#### US-2: 企业研发团队
**作为** 一个企业研发团队的开发者  
**我希望** 每次代码提交后自动生成模块文档  
**以便** 在微服务架构中快速了解各模块的功能和API

#### US-3: DevOps工程师
**作为** 一个DevOps工程师  
**我希望** 在CI/CD流水线中集成文档自动生成  
**以便** 确保每次发布都包含最新的技术文档

### 3.2 详细用户场景

#### 场景1: 首次使用
1. 用户安装AutoDocAgent: `pip install autodoc-agent`
2. 在项目根目录执行: `autodoc init --lang=go --out=docs`
3. 系统自动扫描全仓库，生成模块映射和初始文档
4. 5分钟内完成10万行代码仓库的文档生成

#### 场景2: 日常开发流程
1. 开发者提交代码: `git commit -m "feat: add user authentication"`
2. 推送代码: `git push origin main`
3. GitHub Action自动触发文档更新
4. 30秒内收到"docs updated"通知
5. 查看生成的模块README，包含本次变更摘要

#### 场景3: 网络异常处理
1. 网络连接异常，LLM API调用失败
2. 系统自动降级到本地OSS小模型
3. 5秒内完成文档更新
4. 记录异常日志，不影响正常开发流程

---

## 4. 功能需求

### 4.1 初始化功能 (F-1)

#### F-1-1: 仓库语言识别
**需求**: 系统必须能够自动识别仓库的主要编程语言和框架  
**验收标准**: 
- 支持Go、Python、Java、TypeScript四种语言
- 识别准确率 > 95%
- 支持混合语言仓库（识别主要语言）

#### F-1-2: 配置文件生成
**需求**: 系统必须生成`.autodoc/`目录和相关配置文件  
**验收标准**:
- 生成`snapshot.sha`文件记录文档水印
- 生成`module_map.json`文件映射文件路径到模块名
- 创建`logs/`和`cache/`目录
- 目录结构符合PRD附录A规范

#### F-1-3: 全仓库扫描
**需求**: 系统必须对全仓库进行AST扫描并生成模块级README  
**验收标准**:
- 支持100k行代码仓库，扫描时间 ≤ 5分钟
- 生成包含功能概述、核心API、示例代码的README
- 中文内容占比80%，英文内容占比20%

### 4.2 增量更新功能 (F-2)

#### F-2-1: Git事件监听
**需求**: 系统必须监听`git push`事件（本地CLI或GitHub Action）  
**验收标准**:
- 触发延迟 ≤ 2秒
- 支持本地CLI和GitHub Action两种模式
- 支持自定义触发条件

#### F-2-2: 差异计算
**需求**: 系统必须计算`<snapshot.sha>..HEAD`的文件差异  
**验收标准**:
- 只解析改动模块，耗时 ≤ 1秒
- 支持文件级和函数级差异分析
- 正确处理新增、修改、删除的文件

#### F-2-3: LLM文档生成
**需求**: 系统必须调用LLM生成/更新对应模块文档  
**验收标准**:
- 单模块LLM耗时 ≤ 2秒（网络正常）
- 生成包含"本次变更摘要"的文档
- 自动生成Mermaid类图或时序图
- 网络异常时降级到本地OSS模型

#### F-2-4: 自动提交
**需求**: 系统必须自动commit或提PR，更新snapshot.sha  
**验收标准**:
- 无人工干预完成文档提交
- 支持直接commit和创建PR两种模式
- 提交信息包含变更摘要

### 4.3 文档内容功能 (F-3)

#### F-3-1: README内容结构
**需求**: 每个模块README必须包含功能概述、核心API、示例代码  
**验收标准**:
- 中文内容占比80%，英文内容占比20%
- 包含模块功能概述（100-200字）
- 列出核心API接口和参数说明
- 提供2-3个典型使用示例

#### F-3-2: 图表生成
**需求**: 类/函数变更必须自动生成Mermaid类图或时序图  
**验收标准**:
- 图例渲染正确，支持GitHub Markdown预览
- 类图显示类之间的关系和主要方法
- 时序图显示关键函数调用流程
- 图表大小适中，不超过100行

#### F-3-3: 变更摘要
**需求**: 必须提供"本次变更摘要"段落  
**验收标准**:
- 摘要长度50字以内
- 放在文件顶部，便于快速了解
- 包含变更类型（新增/修改/删除）
- 突出核心功能变更

### 4.4 用户交互功能 (F-4)

#### F-4-1: CLI界面
**需求**: 系统必须提供本地CLI工具  
**验收标准**:
- 支持`autodoc init`、`autodoc update`、`autodoc --help`命令
- 使用Typer自动生成帮助文档
- 提供清晰的错误信息和进度提示
- 支持配置文件和环境变量

#### F-4-2: GitHub Action
**需求**: 系统必须提供GitHub Action配置  
**验收标准**:
- 提供`.github/workflows/autodoc.yml`模板
- 一键启用，无需额外配置
- 支持自定义触发条件和输出目录
- 提供详细的状态反馈

#### F-4-3: 跳过机制
**需求**: 用户必须能够在commit message中跳过文档生成  
**验收标准**:
- 支持`[skip-autodoc]`标记
- 使用正则表达式匹配
- 在日志中记录跳过原因
- 不影响其他commit的正常处理

### 4.5 性能与可靠性功能 (F-5)

#### F-5-1: 性能要求
**需求**: 增量更新总耗时必须 ≤ 3秒（含网络）  
**验收标准**:
- 95%分位响应时间 ≤ 3秒
- 支持并发处理多个模块
- 提供性能监控和统计

#### F-5-2: 容错机制
**需求**: 网络异常时必须降级到本地OSS小模型  
**验收标准**:
- 降级后耗时 ≤ 5秒
- 自动重试3次
- 记录详细的错误日志
- 不影响正常开发流程

#### F-5-3: 日志记录
**需求**: 失败必须自动重试并写日志  
**验收标准**:
- 日志存储在`~/.autodoc/logs/`目录
- 使用JSONL格式记录详细日志
- 包含时间戳、操作类型、结果状态
- 支持日志轮转和清理

---

## 5. 非功能需求

### 5.1 兼容性要求
- **Python版本**: 支持Python 3.10及以上版本
- **Git版本**: 支持Git 2.30及以上版本
- **操作系统**: 支持Windows、macOS、Linux
- **Git平台**: 支持GitHub、GitLab、Gitea

### 5.2 安全要求
- **API密钥管理**: LLM API Key仅保存在本地`keyring`
- **GitHub Action安全**: 使用GitHub secrets存储敏感信息
- **权限控制**: 最小权限原则，只访问必要的文件和API
- **数据保护**: 不收集或传输用户代码内容

### 5.3 可观测性要求
- **日志格式**: 每步输出JSONL格式日志
- **监控指标**: 提供Prometheus指标（可选）
- **错误追踪**: 详细的错误堆栈和上下文信息
- **性能统计**: 响应时间、成功率、错误率统计

### 5.4 开源协议
- **许可证**: MIT开源协议
- **依赖管理**: 使用标准Python包管理工具
- **文档开源**: 所有文档和配置模板开源

---

## 6. 非目标（超出范围）

### 6.1 明确不包含的功能
- **IDE插件**: 不开发VSCode、IntelliJ等IDE插件
- **图形化界面**: 不提供Web界面或桌面应用
- **多格式导出**: 不支持Word、PDF等格式导出
- **多语言翻译**: 不支持除中英文外的其他语言全文翻译
- **代码质量分析**: 不进行代码质量评估或重构建议
- **文档版本管理**: 不提供文档历史版本对比功能

### 6.2 未来版本考虑
- **更多编程语言**: 后续版本可能支持C++、Rust等语言
- **自定义模板**: 允许用户自定义文档生成模板
- **团队协作**: 支持团队级别的文档管理
- **集成更多平台**: 支持更多Git托管平台

---

## 7. 设计考虑

### 7.1 技术架构
```
┌--------------┐     Webhook     ┌--------------┐
│ GitHub Push  │ --------------> │ FastAPI/CLI  │
└--------------┘                 └------┬-------┘
                                       |
      ┌-------------┬------------------┴----------------┐
      │ 1. Git Diff │ 2. AST 解析      │ 3. LLM 生成   │
      │ 耗时 < 1s   │ 多进程并行       │ 耗时 < 2s     │
      └-------------┴------------------┬----------------┘
                                       |
                             ┌---------┴---------┐
                             │ 4. 写回 docs/*.md │
                             │ 5. git commit     │
                             └-------------------┘
```

### 7.2 目录结构
```
.autodoc/
├── snapshot.sha          # 文档水印 commit
├── module_map.json       # {file_path: module_name}
├── logs/
│   └── 2025-07-19.jsonl
└── cache/
    └── ast.pickle        # 可选 AST 缓存
```

### 7.3 UI/UX考虑
- **命令行界面**: 简洁明了，提供进度条和状态提示
- **错误处理**: 友好的错误信息，包含解决建议
- **配置简化**: 最小化配置，支持智能默认值
- **反馈机制**: 及时的状态反馈和完成通知

---

## 8. 技术考虑

### 8.1 核心技术栈
- **AST解析**: 使用libcst进行Python代码解析，其他语言使用对应工具
- **LLM集成**: 支持OpenAI、Claude等主流LLM API
- **本地模型**: 集成Ollama等本地OSS模型作为降级方案
- **并发处理**: 使用asyncio和多进程提高性能

### 8.2 性能优化
- **增量计算**: 只处理变更的文件和模块
- **缓存机制**: AST解析结果缓存，避免重复计算
- **并行处理**: 多模块并行生成文档
- **资源控制**: 限制并发数和内存使用

### 8.3 依赖关系
- **Git集成**: 依赖Git命令行工具和Python Git库
- **LLM API**: 依赖OpenAI、Anthropic等API
- **Markdown渲染**: 支持Mermaid图表渲染
- **日志系统**: 使用标准Python logging模块

---

## 9. 成功指标

### 9.1 技术指标
- **响应时间**: 增量更新95%分位 ≤ 3秒
- **成功率**: 文档生成成功率 > 95%
- **覆盖率**: 支持4种主流编程语言
- **性能**: 100k行代码仓库初始化 ≤ 5分钟

### 9.2 用户体验指标
- **易用性**: 首次使用5分钟内完成配置
- **满意度**: 用户反馈评分 > 4.0/5.0
- **采用率**: 开源项目采用率目标 > 100个
- **活跃度**: 月活跃用户数目标 > 1000

### 9.3 业务指标
- **文档质量**: 生成的文档人工Review通过率 > 90%
- **维护成本**: 减少文档维护时间 > 80%
- **更新及时性**: 代码提交到文档更新延迟 < 30秒

---

## 10. 开发里程碑

### 10.1 四周开发计划

#### 第一周 (W1): 脚手架 + AST 扫描
**任务**:
- 搭建项目基础架构
- 实现CLI工具框架
- 开发AST解析器
- 生成module_map.json

**输出**:
- CLI `init`命令可用
- 支持Python代码AST解析
- 生成基础模块映射

**验收标准**:
- 本地跑通10k行Python仓库
- CLI帮助信息完整
- 模块映射准确率 > 95%

#### 第二周 (W2): LLM 文档模板
**任务**:
- 设计文档生成模板
- 开发LLM集成模块
- 固化Prompt模板
- 实现Markdown渲染

**输出**:
- README模板系统
- LLM API集成
- Mermaid图表生成

**验收标准**:
- 人工Review通过率 > 90%
- 文档内容结构完整
- 图表渲染正确

#### 第三周 (W3): 增量更新 + GitHub Action
**任务**:
- 实现Git差异计算
- 开发增量更新逻辑
- 创建GitHub Action
- 测试端到端流程

**输出**:
- `.github/workflows/autodoc.yml`
- 增量更新功能
- 自动提交机制

**验收标准**:
- 在线仓库Demo可用
- 增量更新耗时 < 3秒
- GitHub Action正常工作

#### 第四周 (W4): 性能优化 + 文档
**任务**:
- 性能优化和调优
- 完善错误处理
- 编写用户文档
- 录制演示视频

**输出**:
- 录屏GIF演示
- 性能测试报告
- 完整的用户文档

**验收标准**:
- P95响应时间 ≤ 3秒
- 错误处理完善
- 文档清晰易懂

---

## 11. 开放问题

### 11.1 技术问题
1. **LLM API限制**: 如何处理LLM API的速率限制和配额问题？
2. **大文件处理**: 对于超过LLM token限制的大文件，如何分段处理？
3. **多语言支持**: 如何统一不同编程语言的AST解析接口？
4. **缓存策略**: AST缓存的有效期和清理策略如何确定？

### 11.2 产品问题
1. **文档质量评估**: 如何自动评估生成文档的质量？
2. **用户反馈**: 如何收集和处理用户对生成文档的反馈？
3. **定制化需求**: 如何处理不同项目的特殊文档需求？
4. **团队协作**: 如何支持团队级别的文档管理？

### 11.3 运营问题
1. **成本控制**: 如何控制LLM API调用成本？
2. **监控告警**: 需要哪些关键指标的监控和告警？
3. **用户支持**: 如何提供有效的用户支持和问题解决？
4. **版本升级**: 如何处理用户配置的向后兼容性？

---

## 12. 风险评估与对策

### 12.1 技术风险

#### 风险1: LLM调用失败
**概率**: 中等  
**影响**: 高  
**对策**: 
- 实现本地OSS模型作为降级方案
- 建立重试队列和错误恢复机制
- 提供详细的错误日志和诊断信息

#### 风险2: 大文件diff超限制
**概率**: 低  
**影响**: 中等  
**对策**: 
- 按函数级别切片，只传输变更片段
- 实现智能的代码分割算法
- 提供配置选项控制处理粒度

#### 风险3: AST解析语言版本差异
**概率**: 低  
**影响**: 中等  
**对策**: 
- 使用libcst自带版本检测
- 提供语言版本配置选项
- 建立语言版本兼容性测试

### 12.2 产品风险

#### 风险1: 文档质量不达标
**概率**: 中等  
**影响**: 高  
**对策**: 
- 建立文档质量评估体系
- 提供人工Review和反馈机制
- 持续优化Prompt模板

#### 风险2: 性能不达标
**概率**: 中等  
**影响**: 高  
**对策**: 
- 建立性能基准和监控体系
- 实现多级缓存和并行处理
- 提供性能调优指南

#### 风险3: 用户接受度低
**概率**: 低  
**影响**: 高  
**对策**: 
- 提供详细的使用文档和示例
- 建立用户反馈收集机制
- 持续改进用户体验

---

## 13. 附录

### 13.1 命令行示例
```bash
# 安装
pip install autodoc-agent

# 初始化
autodoc init --lang=go --out=docs

# 立即增量更新
autodoc update --repo=. --remote=github

# 查看帮助
autodoc --help
```

### 13.2 GitHub Action配置
```yaml
name: AutoDoc Agent
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  autodoc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install AutoDoc Agent
      run: pip install autodoc-agent
    - name: Run AutoDoc
      run: autodoc update
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
```

### 13.3 配置选项
```json
{
  "language": "python",
  "output_dir": "docs",
  "llm_provider": "openai",
  "model": "gpt-4",
  "max_tokens": 4000,
  "temperature": 0.1,
  "retry_count": 3,
  "skip_patterns": ["[skip-autodoc]"],
  "include_patterns": ["*.py", "*.go", "*.java", "*.ts"],
  "exclude_patterns": ["tests/*", "docs/*", "*.md"]
}
```

---

**文档版本**: v1.0  
**最后更新**: 2025-07-19  
**负责人**: 开发团队  
**审核人**: 产品经理 